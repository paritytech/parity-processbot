---
apiVersion: v1
kind: Service
metadata:
  name: parity-processbot
  namespace: {{ .Values.processbot.config.KUBE_NAMESPACE }}
  labels:
    app: parity-processbot
spec:
  ports:
    - name: backend
      port: {{ .Values.processbot.config.WEBHOOK_PORT }}
  selector:
    app: parity-processbot
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: parity-processbot
  namespace: {{ .Values.processbot.config.KUBE_NAMESPACE }}
  labels:
    app: parity-processbot
spec:
  selector:
    matchLabels:
      app: parity-processbot
  serviceName: parity-processbot
  updateStrategy:
    type: RollingUpdate
  replicas: 1
  template:
    metadata:
      labels:
        app: parity-processbot
    spec:
      volumes:
      - name: processbot-key-volume
        secret:
          secretName: processbot-key
          defaultMode: 256
      - name: database
        persistentVolumeClaim:
          claimName: processbot-pv-claim
      containers:
      - name: parity-processbot
        imagePullPolicy: Always
        image: paritytech/processbot:{{ .Values.dockerTag }}
        volumeMounts:
        - name: database
          mountPath: {{ quote .Values.processbot.config.DB_PATH }}
        ports:
        - name: backend
          containerPort: {{ .Values.processbot.config.WEBHOOK_PORT }}
        env:
            - name: WEBHOOK_SECRET
              valueFrom:
                  secretKeyRef:
                      name: env-secrets
                      key: WEBHOOK_SECRET
            - name: RUST_BACKTRACE
              value: full
            - name: RUST_LOG
              value: debug
            - name: INSTALLATION_LOGIN
              value: {{ .Values.orgName }}
            - name: WEBHOOK_PORT
              value: {{ quote .Values.processbot.config.WEBHOOK_PORT }}
            - name: GITHUB_APP_ID
              value: {{ quote .Values.processbot.config.GITHUB_APP_ID }}
            - name: DB_PATH
              value: {{ quote .Values.processbot.config.DB_PATH }}


---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: processbot-pv-claim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
